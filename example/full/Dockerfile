FROM python:3.9.2 AS builder
RUN mkdir /build
WORKDIR /build

RUN --mount=type=cache,target=/var/cache/apt \
    --mount=type=cache,target=/var/lib/apt \
    apt update && \
    apt install -y git-lfs libopenblas-dev gfortran build-essential
ENV PIP_NO_WARN_SCRIPT_LOCATION=0 \
    PIP_USER=1 \
    PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION=python \
    PYTHONPYCACHEPREFIX="$HOME/.pycache" \
    GIT_SSH_COMMAND="ssh -o StrictHostKeyChecking=no" \
    PIP_DISABLE_PIP_VERSION_CHECK=1
RUN --mount=type=cache,target=/root/.cache \
    --mount=type=ssh,required=true \
    --mount=type=bind,source=./requirements.txt,target=/tmp/0requirements.txt \
    pip install \
        --retries 2 \
        --extra-index-url https://mirrors.sustech.edu.cn/pypi/simple \
        -r /tmp/0requirements.txt \
        numpy==1.22 slycot git+https://user:secret@github.com/moskomule/anatome.git@dev git+ssh://git@github.com/RRZE-HPC/pycachesim.git
RUN find /root/.local/lib/python*/ -name 'tests' -exec rm -r '{}' + && \
    find /root/.local/lib/python*/site-packages/ -name '*.so' -exec sh -c 'file "{}" | grep -q "not stripped" && strip -s "{}"' \; && \
    find /root/.local/lib/python*/ -type f -name '*.pyc' -delete && \
    find /root/.local/lib/python*/ -type d -name '__pycache__' -delete

FROM gcr.io/distroless/python3:nonroot@sha256:b1ae632fcc5a20c84a28b49a3c45a51033c59d8569bf40164fffe66de8330ff4
LABEL org.opencontainers.image.description="autogenerated by mopy" \
      moby.buildkit.frontend="mopy" \
      mopy.version="v1" \
      mopy.python.version="3.9.2" \
      mopy.sbom="[\"numpy==1.22\", \"slycot\", \"git+https://github.com/moskomule/anatome.git@dev\", \"git+ssh://git@github.com/RRZE-HPC/pycachesim.git\", \"./requirements.txt\"]" \
      fizz="buzz" \
      foo="buzz"
ENV PYTHONUNBUFFERED=1 \
    PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION=python
COPY --from=builder --chown=nonroot:nonroot /root/.local/ /home/nonroot/.local/
COPY --chown=nonroot:nonroot ./my-python-app/ /home/nonroot/my-python-app
ENTRYPOINT [ "python" ]
WORKDIR /home/nonroot/my-python-app
CMD [ "main.py" ]
